#include "iso/iso_files.h"
#include "iso/iso_convert.h"

using namespace iso;

const char *tags[] = {
	"ABBR",	//{ABBREVIATION}: 		A short name of a title, description, or name.
	"ADDR",	//{ADDRESS}: 			The contemporary place, usually required for postal purposes, of an individual, a submitter of information, a repository, a business, a school, or a company.
	"ADR1",	//{ADDRESS1}: 			The first line of an address.
	"ADR2",	//{ADDRESS2}: 			The second line of an address.
	"ADOP",	//{ADOPTION}: 			Pertaining to creation of a child-parent relationship that does not exist biologically.
	"AFN",	//{AFN}: 				A unique permanent record file number of an individual record stored in Ancestral File.
	"AGE",	//{AGE}: 				The age of the individual at the time an event occurred, or the age listed in the document.
	"AGNC",	//{AGENCY}: 			The institution or individual having authority and/or responsibility to manage or govern.
	"ALIA",	//{ALIAS}: 				An indicator to link different record descriptions of a person who may be the same person.
	"ANCE",	//{ANCESTORS}: 			Pertaining to forbearers of an individual.
	"ANCI",	//{ANCES_INTEREST}: 	Indicates an interest in additional research for ancestors of this individual. (See also DESI.)
	"ANUL",	//{ANNULMENT}: 			Declaring a marriage void from the beginning (never existed).
	"ASSO",	//{ASSOCIATES}: 		An indicator to link friends, neighbors, relatives, or associates of an individual.
	"AUTH",	//{AUTHOR}: 			The name of the individual who created or compiled information.
	"BAPL",	//{BAPTISM-LDS}: 		The event of baptism performed at age eight or later by priesthood authority of the LDS Church. (See also BAPM)
	"BAPM",	//{BAPTISM}: 			The event of baptism (not LDS), performed in infancy or later. (See also BAPL, and CHR.)
	"BARM",	//{BAR_MITZVAH}: 		The ceremonial event held when a Jewish boy reaches age 13.
	"BASM",	//{BAS_MITZVAH}: 		The ceremonial event held when a Jewish girl reaches age 13, also known as "Bat Mitzvah."
	"BIRT",	//{BIRTH}: 				The event of entering into life.
	"BLES",	//{BLESSING}: 			A religious event of bestowing divine care or intercession. Sometimes given in connection with a naming ceremony.
	"BLOB",	//{BINARY_OBJECT}: 		A grouping of data used as input to a multimedia system that processes binary data to represent images, sound, and video.
	"BURI",	//{BURIAL}: 			The event of the proper disposing of the mortal remains of a deceased person.
	"CALN",	//{CALL_NUMBER}: 		The number used by a repository to identify the specific items in its collections.
	"CAST",	//{CASTE}: 				The name of an individual's rank or status in society, based on racial or religious differences, or differences in wealth, inherited rank, profession, occupation, etc.
	"CAUS",	//{CAUSE}: 				A description of the cause of the associated event or fact, such as the cause of death.
	"CENS",	//{CENSUS}: 			The event of the periodic count of the population for a designated locality, such as a national or state Census.
	"CHAN",	//{CHANGE}: 			Indicates a change, correction, or modification. Typically used in connection with a DATE to specify when a change in information occurred.
	"CHAR",	//{CHARACTER}: 			An indicator of the character set used in writing this automated information.
	"CHIL",	//{CHILD}: 				The natural, adopted, or sealed (LDS) child of a father and a mother.
	"CHR",	//{CHRISTENING}: 		The religious event (not LDS) of baptizing and/or naming a child.
	"CHRA",	//{ADULT_CHRISTENING}: 	The religious event (not LDS) of baptizing and/or naming an adult person.
	"CITY",	//{CITY}: 				A lower level jurisdictional unit. Normally an incorporated municipal unit.
	"CONC",	//{CONCATENATION}: 		An indicator that additional data belongs to the superior value. The information from the CONC value is to be connected to the value of the superior preceding line without a space and without a carriage return and/or new line character. Values that are split for a CONC tag must always be split at a non-space. If the value is split on a space the space will be lost when concatenation takes place. This is because of the treatment that spaces get as a GEDCOM delimiter, many GEDCOM values are trimmed of trailing spaces and some systems look for the first non-space starting after the tag to determine the beginning of the value.
	"CONF",	//{CONFIRMATION}: 		The religious event (not LDS) of conferring the gift of the Holy Ghost and, among protestants, full church membership.
	"CONL",	//{CONFIRMATION_L}: 	The religious event by which a person receives membership in the LDS Church.
	"CONT",	//{CONTINUED}: 			An indicator that additional data belongs to the superior value. The information from the CONT value is to be connected to the value of the superior preceding line with a carriage return and/or new line character. Leading spaces could be important to the formatting of the resultant text. When importing values from CONT lines the reader should assume only one delimiter character following the CONT tag. Assume that the rest of the leading spaces are to be a part of the value.
	"COPR",	//{COPYRIGHT}: 			A statement that accompanies data to protect it from unlawful duplication and distribution.
	"CORP",	//{CORPORATE}: 			A name of an institution, agency, corporation, or company.
	"CREM",	//{CREMATION}: 			Disposal of the remains of a person's body by fire.
	"CTRY",	//{COUNTRY}: 			The name or code of the country.
	"DATA",	//{DATA}: 				Pertaining to stored automated information.
	"DATE",	//{DATE}: 				The time of an event in a calendar format.
	"DEAT",	//{DEATH}: 				The event when mortal life terminates.
	"DESC",	//{DESCENDANTS}: 		Pertaining to offspring of an individual.
	"DESI",	//{DESCENDANT_INT}: 	Indicates an interest in research to identify additional descendants of this individual. (See also ANCI.)
	"DEST",	//{DESTINATION}: 		A system receiving data.
	"DIV",	//{DIVORCE}: 			An event of dissolving a marriage through civil action.
	"DIVF",	//{DIVORCE_FILED}: 		An event of filing for a divorce by a spouse.
	"DSCR",	//{PHY_DESCRIPTION}:	The physical characteristics of a person, place, or thing.
	"EDUC",	//{EDUCATION}: 			Indicator of a level of education attained.
	"EMIG",	//{EMIGRATION}: 		An event of leaving one's homeland with the intent of residing elsewhere.
	"ENDL",	//{ENDOWMENT}:			A religious event where an endowment ordinance for an individual was performed by priesthood authority in an LDS temple.
	"ENGA",	//{ENGAGEMENT}: 		An event of recording or announcing an agreement between two people to become married.
	"EVEN",	//{EVENT}: 				A noteworthy happening related to an individual, a group, or an organization.
	"FAM",	//{FAMILY}: 			Identifies a legal, common law, or other customary relationship of man and woman and their children, if any, or a family created by virtue of the birth of a child to its biological father and mother.
	"FAMC",	//{FAMILY_CHILD}: 		Identifies the family in which an individual appears as a child.
	"FAMF",	//{FAMILY_FILE}: 		Pertaining to, or the name of, a family file. Names stored in a file that are assigned to a family for doing temple ordinance work.
	"FAMS",	//{FAMILY_SPOUSE}: 		Identifies the family in which an individual appears as a spouse.
	"FCOM",	//{FIRST_COMMUNION}:	A religious rite, the first act of sharing in the Lord's supper as part of church worship.
	"FILE",	//{FILE}: 				An information storage place that is ordered and arranged for preservation and reference.
	"FORM",	//{FORMAT}: 			An assigned name given to a consistent format in which information can be conveyed.
	"GEDC",	//{GEDCOM}: 			Information about the use of GEDCOM in a transmission.
	"GIVN",	//{GIVEN_NAME}			A given or earned name used for official identification of a person.
	"GRAD",	//{GRADUATION}: 		An event of awarding educational diplomas or degrees to individuals.
	"HEAD",	//{HEADER}: 			Identifies information pertaining to an entire GEDCOM transmission.
	"HUSB",	//{HUSBAND}: 			An individual in the family role of a married man or father.
	"IDNO",	//{IDENT_NUMBER}: 		A number assigned to identify a person within some significant external system.
	"IMMI",	//{IMMIGRATION}: 		An event of entering into a new locality with the intent of residing there.
	"INDI",	//{INDIVIDUAL}: 		A person.
	"LANG",	//{LANGUAGE}:			The name of the language used in a communication or transmission of information.
	"LEGA",	//{LEGATEE}:			A role of an individual acting as a person receiving a bequest or legal devise.
	"MARB",	//{MARRIAGE_BANN}: 		An event of an official public notice given that two people intend to marry.
	"MARC",	//{MARR_CONTRACT}: 		An event of recording a formal agreement of marriage, including the prenuptial agreement in which marriage partners reach agreement about the property rights of one or both, securing property to their children.
	"MARL",	//{MARR_LICENSE}: 		An event of obtaining a legal license to marry.
	"MARR",	//{MARRIAGE}: 			A legal, common-law, or customary event of creating a family unit of a man and a woman as husband and wife.
	"MARS",	//{MARR_SETTLEMENT}:	An event of creating an agreement between two people contemplating marriage, at which time they agree to release or modify property rights that would otherwise arise from the marriage.
	"MEDI",	//{MEDIA}: 				Identifies information about the media or having to do with the medium in which information is stored.
	"NAME",	//{NAME}: 				A word or combination of words used to help identify an individual, title, or other item. More than one NAME line should be used for people who were known by multiple names.
	"NATI",	//{NATIONALITY}: 		The national heritage of an individual.
	"NATU",	//{NATURALIZATION}: 	The event of obtaining citizenship.
	"NCHI",	//{CHILDREN_COUNT}: 	The number of children that this person is known to be the parent of (all marriages) when subordinate to an individual, or that belong to this family when subordinate to a FAM_RECORD.
	"NICK",	//{NICKNAME}: 			A descriptive or familiar that is used instead of, or in addition to, one's proper name.
	"NMR",	//{MARRIAGE_COUNT}: 	The number of times this person has participated in a family as a spouse or parent.
	"NOTE",	//{NOTE}: 				Additional information provided by the submitter for understanding the enclosing data.
	"NPFX",	//{NAME_PREFIX}: 		Text which appears on a name line before the given and surname parts of a name. i.e. ( Lt. Cmndr. ) Joseph /Allen/ jr. In this example Lt. Cmndr. is considered as the name prefix portion.
	"NSFX",	//{NAME_SUFFIX}: 		Text which appears on a name line after or behind the given and surname parts of a name. i.e. Lt. Cmndr. Joseph /Allen/ ( jr. ) In this example jr. is considered as the name suffix portion.
	"OBJE",	//{OBJECT}: 			Pertaining to a grouping of attributes used in describing something. Usually referring to the data required to represent a multimedia object, such an audio recording, a photograph of a person, or an image of a document.
	"OCCU",	//{OCCUPATION}: 		The type of work or profession of an individual.
	"ORDI",	//{ORDINANCE}: 			Pertaining to a religious ordinance in general.
	"ORDN",	//{ORDINATION}: 		A religious event of receiving authority to act in religious matters.
	"PAGE",	//{PAGE}: 				A number or description to identify where information can be found in a referenced work.
	"PEDI",	//{PEDIGREE}: 			Information pertaining to an individual to parent lineage chart.
	"PHON",	//{PHONE}: 				A unique number assigned to access a specific telephone.
	"PLAC",	//{PLACE}: 				A jurisdictional name to identify the place or location of an event.
	"POST",	//{POSTAL_CODE}: 		A code used by a postal service to identify an area to facilitate mail handling.
	"PROB",	//{PROBATE}: 			An event of judicial determination of the validity of a will. May indicate several related court activities over several dates.
	"PROP",	//{PROPERTY}: 			Pertaining to possessions such as real estate or other property of interest.
	"PUBL",	//{PUBLICATION}: 		Refers to when and/or were a work was published or created.
	"QUAY",	//{QUALITY_OF_DATA}:	An assessment of the certainty of the evidence to support the conclusion drawn from evidence.
	"REFN",	//{REFERENCE}: 			A description or number used to identify an item for filing, storage, or other reference purposes.
	"RELA",	//{RELATIONSHIP}: 		A relationship value between the indicated contexts.
	"RELI",	//{RELIGION}: 			A religious denomination to which a person is affiliated or for which a record applies.
	"REPO",	//{REPOSITORY}: 		An institution or person that has the specified item as part of their collection(s).
	"RESI",	//{RESIDENCE}: 			The act of dwelling at an address for a period of time.
	"RESN",	//{RESTRICTION}: 		A processing indicator signifying access to information has been denied or otherwise restricted.
	"RETI",	//{RETIREMENT}: 		An event of exiting an occupational relationship with an employer after a qualifying time period.
	"RFN",	//{REC_FILE_NUMBER}:	A permanent number assigned to a record that uniquely identifies it within a known file.
	"RIN",	//{REC_ID_NUMBER}: 		A number assigned to a record by an originating automated system that can be used by a receiving system to report results pertaining to that record.
	"ROLE",	//{ROLE}: 				A name given to a role played by an individual in connection with an event.
	"SEX",	//{SEX}: 				Indicates the sex of an individual--male or female.
	"SLGC",	//{SEALING_CHILD}: 		A religious event pertaining to the sealing of a child to his or her parents in an LDS temple ceremony.
	"SLGS",	//{SEALING_SPOUSE}: 	A religious event pertaining to the sealing of a husband and wife in an LDS temple ceremony.
	"SOUR",	//{SOURCE}: 			The initial or original material from which information was obtained.
	"SPFX",	//{SURN_PREFIX}: 		A name piece used as a non-indexing pre-part of a surname.
	"SSN",	//{SOC_SEC_NUMBER}: 	A number assigned by the United States Social Security Administration. Used for tax identification purposes.
	"STAE",	//{STATE}: 				A geographical division of a larger jurisdictional area, such as a State within the United States of America.
	"STAT",	//{STATUS}: 			An assessment of the state or condition of something.
	"SUBM",	//{SUBMITTER}: 			An individual or organization who contributes genealogical data to a file or transfers it to someone else.
	"SUBN",	//{SUBMISSION}: 		Pertains to a collection of data issued for processing.
	"SURN",	//{SURNAME}: 			A family name passed on or used by members of a family.
	"TEMP",	//{TEMPLE}: 			The name or code that represents the name a temple of the LDS Church.
	"TEXT",	//{TEXT}: 				The exact wording found in an original source document.
	"TIME",	//{TIME}: 				A time value in a 24-hour clock format, including hours, minutes, and optional seconds, separated by a colon (:). Fractions of seconds are shown in decimal notation.
	"TITL",	//{TITLE}: 				A description of a specific writing or other work, such as the title of a book when used in a source context, or a formal designation used by an individual in connection with positions of royalty or other social status, such as Grand Duke.
	"TRLR",	//{TRAILER}: 			At level 0, specifies the end of a GEDCOM transmission.
	"TYPE",	//{TYPE}: 				A further qualification to the meaning of the associated superior tag. The value does not have any computer processing reliability. It is more in the form of a short one or two word note that should be displayed any time the associated data is displayed.
	"VERS",	//{VERSION}: 			Indicates which version of a product, item, or publication is being used or referenced.
	"WIFE",	//{WIFE}: 				An individual in the role as a mother and/or married woman.
	"WILL",	//{WILL}: 				A legal document treated as an event, by which a person disposes of his or her estate, to take effect after death. The event date is the date the will was signed while the person was alive. (See also PROBate.)
};

class GEDCOMFileHandler : public FileHandler {
	const char*		GetExt() override { return "ged";		}
	const char*		GetDescription() override { return "GEDCOM";	}
	ISO_ptr<void>	Read(tag id, istream_ref file) override;
} gedcom;

char *skip_whitespace(char *p) {
	while (*p == ' ')
		p++;
	return  p;
}

char *read_label(char *p, char *label) {
	while (*p != '@')
		*label++ = *p++;
	*label = 0;
	return skip_whitespace(++p);
}

ISO_TYPEDEF(GED, anything);

ISO_ptr<void> GEDCOMFileHandler::Read(tag id, istream_ref file) {
	array<ISO_ptr<anything>, 99>	levels;
	map<string, ISO_ptr<anything> >	lookup;

	levels[0] = MakePtr(&def_GED, id);

	int		linenum	= 0;
	for (;;) {
		char	line[1024], tag[32], *p;

		for (p = line; p == line; ) {
			int		c	= 0;
			p	= line;
			while ((c = file.getc()) != EOF && c != '\n' && c != '\r')
				*p++ = c;
			if (c == EOF)
				return levels[0];
		}

		linenum++;

		ISO_ASSERT(p - line < 1024);

		*p++ = 0;
		p = line;
		int	indent	= 0;
		while (*p >= '0' && *p <= '9')
			indent = indent * 10 + *p++ - '0';

		p = skip_whitespace(p);

		ISO_ptr<anything>	v;
		if (*p == '@') {
			char	label[256];
			p = read_label(++p, label);
			ISO_ptr<anything>	&v0 = lookup[label];
			if (!v0)
				v0.Create();
			v = v0;
		} else {
			v.Create();
		}

		char	*t = tag;
		while (*p > ' ')
			*t++ = *p++;
		*t = 0;
		p++;

		ISO_ptr<void>	x;
		if (*p == '@') {
			char	label[256];
			p = read_label(++p, label);
			ISO_ptr<anything>	&v0 = lookup[label];
			if (!v0)
				v0.Create();
			x = v0;

		} else if (str(p, 5) == "http:") {
			x.CreateExternal(p, tag);

		} else if (*p) {
			x = ISO_ptr<string>(0, p);

		}

		if (x)
			v->Append(x);

		v.SetID(tag);

		if (levels[indent + 1] && levels[indent + 1]->Count() == 1 && levels[indent]->Count() && !(*levels[indent + 1])[0].ID()) {
			anything		&a = *levels[indent];
			ISO_ptr<void>	b = (*levels[indent + 1])[0];
			b.SetID(levels[indent + 1].ID());
			a[a.Count() - 1] = b;
		}
		levels[indent]->Append(v);
		levels[indent + 1] = v;

	}
}
